<!doctype html>
<html lang="en" class="theme-light">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="pragma" content="no-cache" />
    <meta http-equiv="expires" content="-1" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Working Schedule</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
    />
  </head>
  <body x-data="data">
    <section class="section">
      <h1 class="title">Schedules</h1>
      <table
        class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"
      >
        <tr>
          <th>Shift</th>
          <th>Staff</th>
          <th>Mon</th>
          <th>Tue</th>
          <th>Wed</th>
          <th>Thu</th>
          <th>Fri</th>
        </tr>
        <template x-for="shift in shifts">
          <template x-if="schedules[shift]">
            <template x-for="staff in Object.keys(schedules[shift]).sort()">
              <tr>
                <td x-text="shift"></td>
                <td x-text="staff"></td>
                <template x-for="weekday in weekdays">
                  <td class="content">
                    <ul>
                      <template
                        x-for="schedule in schedules[shift][staff][weekday]"
                      >
                        <li x-text="schedule.name"></li>
                      </template>
                      <template
                        x-for="schedule in getTrainingSection({staffName: staff, weekday})"
                      >
                        <li x-text="`#${schedule.name}`"></li>
                      </template>
                      <template x-for="dayoffStaff in dayOffs[weekday]">
                        <template x-if="dayoffStaff == staff">
                          <li class="has-text-danger">Day Off</li>
                        </template>
                      </template>
                    </ul>
                  </td>
                </template>
              </tr>
            </template>
          </template>
        </template>
      </table>
    </section>

    <section class="section">
      <h1 class="title">Unassigned Tasks</h1>
      <table class="table is-bordered is-striped is-narrow is-hoverable">
        <tr>
          <th>Weekday</th>
          <th>Shift</th>
          <th>Task</th>
          <th>Trainers</th>
          <th>Trainees</th>
        </tr>
        <template x-for="task in unassignedTasks">
          <tr>
            <td
              x-text="task.weekday.charAt(0).toUpperCase() + task.weekday.substring(1)"
            ></td>
            <td x-text="task.shift"></td>
            <td x-text="task.name"></td>
            <td x-text="task.trainers.join(', ')"></td>
            <td x-text="task.trainees.join(', ')"></td>
          </tr>
        </template>
      </table>
    </section>
  </body>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('data', () => ({
        staffs: [],
        schedules: [],
        shifts: ['Asia', 'EU', 'US'],
        weekdays: ['mon', 'tue', 'wed', 'thu', 'fri'],
        traineeSchedules: [],
        unassignedTasks: [],
        dayOffs: [],
        async init() {
          const ts = Date.now()

          const scheduleResponse = await fetch(
            `./assignedSchedules.json?ts=${ts}`
          )
          const schedules = await scheduleResponse.json()
          this.schedules = schedules

          const traineeResponse = await fetch(
            `./traineeSchedules.json?ts=${ts}`
          )
          this.traineeSchedules = await traineeResponse.json()

          const unassignedResponse = await fetch(
            `./unassignedTasks.json?ts=${ts}`
          )
          this.unassignedTasks = await unassignedResponse.json()

          const dayOffResponse = await fetch(`./dayOffs.json?ts=${ts}`)
          this.dayOffs = await dayOffResponse.json()
        },
        getTrainingSection({ staffName, weekday }) {
          return this.traineeSchedules.filter(
            (schedule) =>
              schedule.trainees.includes(staffName) &&
              schedule.weekday == weekday
          )
        }
      }))
    })
  </script>
</html>
