<!doctype html>
<html lang="en" class="theme-light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Schedules</title>
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.8/dist/cdn.min.js"
    ></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
    />
  </head>
  <body x-data="data">
    <section class="section mb-4 pb-0">
      <h1 class="title">Filters</h1>
      <!--<pre x-text='JSON.stringify(filters, "null", "\t")'></pre>-->
      <form class="mb-5">
        <div class="field is-horizontal">
          <div class="field-body">
            <div class="field">
              <div class="control">
                <div class="select is-fullwidth is-multiple">
                  <select x-model="filters.shifts" multiple size="3">
                    <template x-for="s in data.shifts">
                      <option x-text="s"></option>
                    </template>
                  </select>
                </div>
                <span class="help has-text-link">Filter by Shift</span>
              </div>
            </div>

            <div class="field">
              <div class="control">
                <div class="select is-fullwidth is-multiple">
                  <select x-model="filters.staffs" multiple>
                    <template x-for="s in data.staffs">
                      <option x-text="s"></option>
                    </template>
                  </select>
                </div>

                <span class="help has-text-link">Filter by staffs</span>
              </div>
            </div>

            <div class="field">
              <div class="control">
                <div class="select is-fullwidth is-multiple">
                  <select x-model="filters.cats" multiple>
                    <template x-for="c in data.cats">
                      <option x-text="c"></option>
                    </template>
                  </select>
                </div>
                <span class="help has-text-link">Filter by Category</span>
              </div>
            </div>

            <div class="field">
              <p class="control is-expanded">
                <input
                  class="input"
                  type="text"
                  placeholder="Task"
                  x-model="filters.task"
                />
              </p>

              <span class="help has-text-link">Filter by Task</span>
            </div>
          </div>
        </div>
      </form>
    </section>
    <section class="section">
      <h1 class="title">Schedules</h1>

      <table
        class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"
      >
        <tr>
          <th>Shift</th>
          <th>Staff</th>
          <th>Mon</th>
          <th>Tue</th>
          <th>Wed</th>
          <th>Thu</th>
          <th>Fri</th>
        </tr>
        <template x-for="shift in shifts">
          <template x-if="schedules[shift]">
            <template x-for="staff in staffs">
              <template x-if="staff.shift == shift">
                <tr>
                  <td x-text="shift"></td>
                  <td x-text="staff.name"></td>
                  <template x-for="weekday in weekdays">
                    <td class="content">
                      <ul>
                        <template
                          x-for="schedule in filterSchedules(schedules[shift][staff.name][weekday])"
                        >
                          <li x-text="schedule.name"></li>
                        </template>
                        <template
                          x-for="schedule in getTrainingSection({staffName: staff, weekday})"
                        >
                          <li x-text="`#${schedule.name}`"></li>
                        </template>
                        <template x-for="dayoffStaff in dayOffs[weekday]">
                          <template x-if="dayoffStaff == staff.name">
                            <li class="has-text-danger">Day Off</li>
                          </template>
                        </template>
                      </ul>
                    </td>
                  </template>
                </tr>
              </template>
            </template>
          </template>
        </template>
      </table>
    </section>

    <section class="section">
      <h1 class="title">Tasks by Trainers</h1>
      <table
        class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"
      >
        <tr>
          <td>Shift</td>
          <td>Staff</td>
          <td>Tasks</td>
        </tr>
        <template x-for="shift in shifts">
          <template x-for="staff in staffs">
            <template x-if="staff.shift == shift">
              <template
                x-if="filters.staffs ==0 ||filters.staffs.includes(staff.name)"
              >
                <tr>
                  <td x-text="shift"></td>
                  <td x-text="staff.name"></td>
                  <td class="content">
                    <ul>
                      <template x-for="t in getTasksByStaff(staff.name)">
                        <li x-text="t.name"></li>
                      </template>
                    </ul>
                  </td>
                </tr>
              </template>
            </template>
          </template>
        </template>
      </table>
    </section>

    <section class="section">
      <div class="level">
        <div class="level-item">
          <div>
            <h1 class="title">Unassigned Tasks</h1>
            <table
              class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"
            >
              <tr>
                <th>Weekday</th>
                <th>Shift</th>
                <th>Task</th>
                <th>Trainers</th>
                <th>Trainees</th>
              </tr>
              <template x-for="task in unassignedTasks">
                <tr>
                  <td
                    x-text="task.weekday.charAt(0).toUpperCase() + task.weekday.substring(1)"
                  ></td>
                  <td x-text="task.shift"></td>
                  <td x-text="task.name"></td>
                  <td x-text="task.trainers.join(', ')"></td>
                  <td x-text="task.trainees.join(', ')"></td>
                </tr>
              </template>
            </table>
          </div>
        </div>
        <div class="level-item">
          <div>
            <h1 class="title">Workloads</h1>
            <table
              class="table is-bordered is-striped is-narrow is-hoverable is-fullwidth"
            >
              <tr>
                <th>Shift</th>
                <th>Staff</th>
                <th>Workload</th>
              </tr>
              <template x-for="w in workloads">
                <tr>
                  <td x-text="w.shift"></td>
                  <td x-text="w.name"></td>
                  <td x-text="w.workload"></td>
                </tr>
              </template>
            </table>
          </div>
        </div>
      </div>
    </section>
  </body>
  <script>
    document.addEventListener('alpine:init', () => {
      Alpine.data('data', () => ({
        tasks: [],
        staffs: [],
        schedules: [],
        weekdays: ['mon', 'tue', 'wed', 'thu', 'fri'],
        traineeSchedules: [],
        unassignedTasks: [],
        workloads: [],
        dayOffs: [],
        filters: { staffs: [], shifts: [], cats: [], task: '' },
        async init() {
          const ts = Date.now()
          const taskResponse = await fetch(`./tasks.json?ts=${ts}`)
          this.tasks = await taskResponse.json()

          const scheduleResponse = await fetch(
            `./assignedSchedules.json?ts=${ts}`
          )
          const schedules = await scheduleResponse.json()
          this.schedules = schedules

          const traineeResponse = await fetch(
            `./traineeSchedules.json?ts=${ts}`
          )
          this.traineeSchedules = await traineeResponse.json()

          const unassignedResponse = await fetch(
            `./unassignedTasks.json?ts=${ts}`
          )
          this.unassignedTasks = await unassignedResponse.json()

          const workloadResponse = await fetch(`./workloads.json?ts=${ts}`)
          this.workloads = await workloadResponse.json()

          const dayOffResponse = await fetch(`./dayOffs.json?ts=${ts}`)
          this.dayOffs = await dayOffResponse.json()

          const staffResponse = await fetch(`./staffs.json?ts=${ts}`)
          this.staffs = await staffResponse.json()
        },

        get data() {
          const { schedules, filters } = this
          const shiftFilters = this.filters.shifts

          const staffs = []
          const shifts = []
          const cats = []
          for (const shift in schedules) {
            shifts.push(shift)

            if (shiftFilters.length > 0 && !shiftFilters.includes(shift))
              continue

            for (const staff in schedules[shift]) {
              staffs.push(staff)
              for (const weekday in schedules[shift][staff]) {
                schedules[shift][staff][weekday].forEach((s) => {
                  cats.push(s.cat)
                })
              }
            }
          }
          return {
            shifts,
            staffs: [...new Set(staffs)].sort(),
            cats: [...new Set(cats)].sort()
          }
        },
        get shifts() {
          const { shifts } = this.data
          const shiftFilters = this.filters.shifts
          if (shiftFilters.length == 0) return shifts
          return shifts.filter((s) => shiftFilters.includes(s))
        },
        getTrainingSection({ staffName, weekday }) {
          return this.traineeSchedules.filter(
            (schedule) =>
              schedule.trainees.includes(staffName) &&
              schedule.weekday == weekday
          )
        },

        filterStaffs(staffs) {
          const staffFilters = this.filters.staffs
          if (staffFilters.length == 0) return staffs
          return staffs.filter((s) => staffFilters.includes(s))
        },
        filterSchedules(schedules) {
          const { cats, task } = this.filters
          if (!schedules) return []

          const tempSchedules =
            cats.length == 0
              ? schedules
              : schedules.filter((s) => {
                  return cats.includes(s.cat)
                })

          if (!task) return tempSchedules

          return tempSchedules.filter((t) =>
            t.name.toLowerCase().includes(task.toLowerCase())
          )
        },

        getTasksByStaff(staff) {
          const { tasks } = this
          const { cats, task } = this.filters
          const filteredTasks = tasks
            .filter((t) => {
              if (!cats.length) return true
              return cats.includes(t.cat)
            })
            .filter((t) => {
              return t.trainers.includes(staff)
            })

          if (!task) return filteredTasks
          return filteredTasks.filter((t) =>
            t.name.toLowerCase().includes(task.toLowerCase())
          )
        },
        getStaffsByTask(task) {}
      }))
    })
  </script>
</html>
